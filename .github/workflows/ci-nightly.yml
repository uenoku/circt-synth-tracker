name: CIRCT Nightly Integration Tests

on:
  schedule:
    # Run daily at 12:00 UTC (after CIRCT nightly builds)
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      bitwidths:
        description: 'Comma-separated list of bitwidths to test (e.g. "16,32")'
        required: false
        default: '16,48'
      abc_commands:
        description: 'ABC commands to run on AIG after synthesis via %AIG_TOOL (e.g. "dc2; dc2;")'
        required: false
        default: ''
      equiv_check:
        description: 'Run equivalence check (--equiv-check) during CIRCT synthesis (always enabled for scheduled runs)'
        required: false
        type: boolean
        default: true
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Yosys vs CIRCT Comparison
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/circt/images/circt-integration-test:v20
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install jq (required by install-circt action)
        run: |
          apt-get update && apt-get install -y jq

      - name: Install CIRCT nightly
        uses: circt/install-circt@3f8dda6e1c1965537b5801a43c81c287bac4eae4 # v1.1.1
        with:
          version: 'nightly'
          github-token: ${{ github.token }}

      - name: Add CIRCT to PATH
        run: |
          echo "$GITHUB_WORKSPACE/circt/bin" >> $GITHUB_PATH

      - name: Get CIRCT and Yosys versions
        run: |
          CIRCT_VERSION=$(circt-synth --version | tail -1 | xargs)
          YOSYS_VERSION=$(yosys --version | head -1 | xargs)
          echo "CIRCT_VERSION=$CIRCT_VERSION" >> $GITHUB_ENV
          echo "YOSYS_VERSION=$YOSYS_VERSION" >> $GITHUB_ENV
          echo "CIRCT Version: $CIRCT_VERSION"
          echo "Yosys Version: $YOSYS_VERSION"

      - name: Verify environment
        run: |
          which yosys
          which circt-synth
          which circt-verilog
          which circt-translate
          yosys --version
          circt-synth --version

      - name: Setup tracker
        uses: ./.github/actions/setup-tracker

      - name: Determine equiv-check flag
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ inputs.equiv_check }}" = "true" ]; then
            echo "EQUIV_CHECK=true" >> $GITHUB_ENV
          else
            echo "EQUIV_CHECK=false" >> $GITHUB_ENV
          fi

      - name: Determine equiv-check flag
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ github.event_name }}" = "push" ] || [ "${{ inputs.equiv_check }}" = "true" ]; then
            echo "EQUIV_CHECK=true" >> $GITHUB_ENV
          else
            echo "EQUIV_CHECK=false" >> $GITHUB_ENV
          fi

      - name: Run CIRCT tests
        uses: ./.github/actions/run-benchmark
        with:
          synth_tool: circt
          bitwidths: ${{ github.event.inputs.bitwidths || '16,48' }}
          abc_commands: ${{ github.event.inputs.abc_commands }}
          output_dir: build_circt
          tool_label: circt
          tool_version: ${{ env.CIRCT_VERSION }}
          summary_file: circt-summary.json

      - name: Run Yosys tests
        uses: ./.github/actions/run-benchmark
        with:
          synth_tool: yosys
          bitwidths: ${{ github.event.inputs.bitwidths || '16,48' }}
          abc_commands: ${{ github.event.inputs.abc_commands }}
          output_dir: build_yosys
          tool_label: yosys
          tool_version: ${{ env.YOSYS_VERSION }}
          summary_file: yosys-summary.json

      - name: Run equivalence check
        if: env.EQUIV_CHECK == 'true'
        run: |
          source .venv/bin/activate
          check-cec circt-summary.json yosys-summary.json -o cec.json -j $(nproc)

      - name: Compare results
        # report.html generated here is used for artifacts and non-push/schedule runs.
        # For push/schedule, "Generate time series report" overwrites it with --timeseries-url.
        # CEC_FLAG is exported to GITHUB_ENV so that step can include CEC data too.
        run: |
          source .venv/bin/activate
          CEC_FLAG=""
          [ -f cec.json ] && CEC_FLAG="--cec cec.json"
          echo "CEC_FLAG=${CEC_FLAG}" >> $GITHUB_ENV
          compare-results yosys-summary.json circt-summary.json -o report.html $CEC_FLAG
          compare-results yosys-summary.json circt-summary.json -o report.md $CEC_FLAG
          compare-results yosys-summary.json circt-summary.json -o report.json

      - name: Upload comparison reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comparison-reports
          path: |
            report.html
            report.md
            report.json
            cec.json
            circt-summary.json
            yosys-summary.json

      - name: Upload test outputs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-outputs
          path: |
            build_circt/
            build_yosys/

      - name: Post results summary
        if: always()
        run: |
          echo "## CIRCT Synth Test Results" >> $GITHUB_STEP_SUMMARY
          echo "**CIRCT Version:** \`${CIRCT_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Yosys Version:** \`${YOSYS_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f report.md ]; then
            cat report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fetch existing history from gh-pages branch
        if: (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          curl -s -f \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.raw+json" \
            "https://api.github.com/repos/${{ github.repository }}/contents/history.json?ref=gh-pages" \
            > history.json || echo "[]" > history.json
          echo "History entries: $(python3 -c 'import json,sys; print(len(json.load(open("history.json"))))' 2>/dev/null || echo 0)"

      - name: Append results to history
        if: (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && always()
        run: |
          source .venv/bin/activate
          append-history \
            --circt circt-summary.json \
            --yosys yosys-summary.json \
            -o history.json \
            --max-days 90

      - name: Generate time series report
        if: (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && always()
        run: |
          source .venv/bin/activate
          timeseries-report history.json -o timeseries.html
          compare-results yosys-summary.json circt-summary.json -o report.html --timeseries-url timeseries.html $CEC_FLAG

      - name: Prepare deployment files
        if: (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && always()
        run: |
          mkdir -p deploy
          cp -v report.html deploy/ 2>/dev/null || true
          cp -v timeseries.html deploy/ 2>/dev/null || true
          cp -v history.json deploy/ 2>/dev/null || true
          ls -la deploy/

      - name: Deploy reports to GitHub Pages
        if: (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) && always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
