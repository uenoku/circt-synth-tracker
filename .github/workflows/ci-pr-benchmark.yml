name: CIRCT PR Benchmark

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'CIRCT PR number to benchmark (e.g. 12345)'
        required: true
        type: string
      bitwidths:
        description: 'Comma-separated list of bitwidths to test'
        required: false
        default: '16,48'
      abc_commands:
        description: 'ABC commands to run on AIG after synthesis via %AIG_TOOL (e.g. "dc2; dc2;")'
        required: false
        default: ''
      issue_number:
        description: 'Tracker issue number to post results to (optional)'
        required: false
        type: string
      equiv_check:
        description: 'Run equivalence check (--equiv-check) during CIRCT synthesis'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

# Keep the container image tag in sync with llvm/circt's buildAndTest.yml
env:
  CIRCT_CI_IMAGE: ghcr.io/circt/images/circt-ci-build:20260107030736

jobs:
  benchmark:
    name: Benchmark CIRCT PR #${{ inputs.pr_number }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/circt/images/circt-ci-build:20260107030736

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout tracker repository
        uses: actions/checkout@v4
        with:
          path: tracker
          submodules: recursive

      - name: Install gh and jq
        run: |
          apt-get install -y jq
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
            | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
            | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt-get update
          apt-get install -y gh

      - name: Download pre-built CIRCT (base binaries + LLVM/MLIR install)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID=$(gh run list \
            --repo llvm/circt \
            --workflow uploadReleaseArtifacts.yml \
            --branch main \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          echo "Downloading circt-full-shared-linux-x64.tar.gz from run $RUN_ID"
          gh run download "$RUN_ID" \
            --repo llvm/circt \
            --name "circt-full-shared-linux-x64.tar.gz" \
            --dir .
          mkdir -p circt-prebuilt
          tar xzf circt-full-shared-linux-x64.tar.gz -C circt-prebuilt/
          # Find the actual cmake dirs in case the tarball has a top-level directory
          MLIR_CMAKE_DIR=$(find "$GITHUB_WORKSPACE/circt-prebuilt" -name "MLIRConfig.cmake" -type f -exec dirname {} \; | head -1)
          LLVM_CMAKE_DIR=$(find "$GITHUB_WORKSPACE/circt-prebuilt" -name "LLVMConfig.cmake" -type f -exec dirname {} \; | head -1)
          PREBUILT_BIN_DIR=$(find "$GITHUB_WORKSPACE/circt-prebuilt" -name "circt-synth" -type f -exec dirname {} \; | head -1)
          PREBUILT_LIB_DIR=$(dirname "$(dirname "$LLVM_CMAKE_DIR")")
          echo "MLIR_DIR=$MLIR_CMAKE_DIR" >> $GITHUB_ENV
          echo "LLVM_DIR=$LLVM_CMAKE_DIR" >> $GITHUB_ENV
          echo "$PREBUILT_BIN_DIR" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=$PREBUILT_LIB_DIR${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}" >> $GITHUB_ENV

      - name: Get PR info from llvm/circt
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          BASE_SHA=$(gh pr view "$PR_NUMBER" --repo llvm/circt --json baseRefOid --jq '.baseRefOid')
          HEAD_SHA=$(gh pr view "$PR_NUMBER" --repo llvm/circt --json headRefOid --jq '.headRefOid')
          PR_TITLE=$(gh pr view "$PR_NUMBER" --repo llvm/circt --json title --jq '.title')
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "PR: $PR_NUMBER - $PR_TITLE"
          echo "Base: ${BASE_SHA:0:8}"
          echo "Head: ${HEAD_SHA:0:8}"

      - name: Setup sccache (for CIRCT compilation)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: sccache-circt-${{ runner.os }}-20260107030736
          restore-keys: sccache-circt-${{ runner.os }}-
          max-size: 1G
          variant: sccache

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Python dependencies and build aig-judge
        working-directory: tracker
        run: |
          uv sync
          uv run prepare

      - name: Checkout CIRCT at PR base SHA
        uses: actions/checkout@v4
        with:
          repository: llvm/circt
          ref: ${{ steps.pr-info.outputs.base_sha }}
          submodules: false
          path: circt-base

      - name: Build CIRCT at PR base (before)
        run: |
          cmake -GNinja circt-base \
            -B circt-base/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DMLIR_DIR=$MLIR_DIR \
            -DLLVM_DIR=$LLVM_DIR \
            -DLLVM_USE_LINKER=lld \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCIRCT_ENABLE_BINDINGS_PYTHON=OFF \
            -DCIRCT_SLANG_FRONTEND_ENABLED=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DLLVM_LINK_LLVM_DYLIB=OFF \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          ninja -C circt-base/build -j$(nproc) circt-synth

      - name: Run benchmarks (before)
        run: |
          export PATH="$GITHUB_WORKSPACE/circt-base/build/bin:$PATH"
          BEFORE_VERSION=$(circt-synth --version | tail -1 | xargs)
          echo "CIRCT_VERSION_BEFORE=$BEFORE_VERSION" >> $GITHUB_ENV
          cd tracker
          source .venv/bin/activate
          ABC_COMMANDS="${{ inputs.abc_commands }}"
          ABC_PARAM="${ABC_COMMANDS:+-DABC_COMMANDS=\"$ABC_COMMANDS\"}"
          IFS=',' read -ra BWS <<< "${{ inputs.bitwidths || '16,48' }}"
          for BW in "${BWS[@]}"; do
            lit -v benchmarks/ -DSYNTH_TOOL=circt \
              -DTEST_OUTPUT_DIR=build_before -DBW=$BW $ABC_PARAM || true
          done
          aggregate-results --tool "base" --version "$BEFORE_VERSION" \
            --results-dir build_before -o before-summary.json

      - name: Checkout CIRCT at PR head SHA
        uses: actions/checkout@v4
        with:
          repository: llvm/circt
          ref: ${{ steps.pr-info.outputs.head_sha }}
          submodules: false
          path: circt-pr

      - name: Build CIRCT at PR head (after)
        run: |
          cmake -GNinja circt-pr \
            -B circt-pr/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DMLIR_DIR=$MLIR_DIR \
            -DLLVM_DIR=$LLVM_DIR \
            -DLLVM_USE_LINKER=lld \
            -DCMAKE_C_COMPILER=clang \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCIRCT_ENABLE_BINDINGS_PYTHON=OFF \
            -DCIRCT_SLANG_FRONTEND_ENABLED=OFF \
            -DLLVM_LINK_LLVM_DYLIB=OFF \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          ninja -C circt-pr/build -j$(nproc) circt-synth

      - name: Run benchmarks (after)
        run: |
          export PATH="$GITHUB_WORKSPACE/circt-pr/build/bin:$PATH"
          AFTER_VERSION=$(circt-synth --version | tail -1 | xargs)
          echo "CIRCT_VERSION_AFTER=$AFTER_VERSION" >> $GITHUB_ENV
          cd tracker
          source .venv/bin/activate
          ABC_COMMANDS="${{ inputs.abc_commands }}"
          ABC_PARAM="${ABC_COMMANDS:+-DABC_COMMANDS=\"$ABC_COMMANDS\"}"
          IFS=',' read -ra BWS <<< "${{ inputs.bitwidths || '16,48' }}"
          for BW in "${BWS[@]}"; do
            lit -v benchmarks/ -DSYNTH_TOOL=circt \
              -DTEST_OUTPUT_DIR=build_after -DBW=$BW $ABC_PARAM || true
          done
          aggregate-results --tool "pr" --version "$AFTER_VERSION" \
            --results-dir build_after -o after-summary.json

      - name: Compare before vs after
        run: |
          cd tracker
          source .venv/bin/activate
          EQUIV_FLAG=""
          [ "${{ inputs.equiv_check }}" = "true" ] && EQUIV_FLAG="--equiv-check"
          compare-results before-summary.json after-summary.json -o pr-report.html $EQUIV_FLAG
          compare-results before-summary.json after-summary.json -o pr-report.md $EQUIV_FLAG
          compare-results before-summary.json after-summary.json -o pr-report.json --format json

      - name: Post results to GitHub Actions summary
        if: always()
        run: |
          {
            echo "## CIRCT PR #${{ inputs.pr_number }} Benchmark"
            echo ""
            echo "**[${{ steps.pr-info.outputs.pr_title }}](https://github.com/llvm/circt/pull/${{ inputs.pr_number }})**"
            echo ""
            echo "| | Before | After |"
            echo "|---|---|---|"
            printf "| Commit | \`%.8s\` | \`%.8s\` |\n" \
              "${{ steps.pr-info.outputs.base_sha }}" \
              "${{ steps.pr-info.outputs.head_sha }}"
            echo "| Version | \`${CIRCT_VERSION_BEFORE}\` | \`${CIRCT_VERSION_AFTER}\` |"
            echo ""
            if [ -f tracker/pr-report.md ]; then
              cat tracker/pr-report.md
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Post results comment to tracker issue
        if: always() && inputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            let reportBody = '';
            try {
              reportBody = fs.readFileSync('tracker/pr-report.md', 'utf8');
            } catch (e) {
              reportBody = '_Report not generated._';
            }
            const prNumber = '${{ inputs.pr_number }}';
            const prTitle = '${{ steps.pr-info.outputs.pr_title }}';
            const baseSha = '${{ steps.pr-info.outputs.base_sha }}'.slice(0, 8);
            const headSha = '${{ steps.pr-info.outputs.head_sha }}'.slice(0, 8);
            const beforeVer = process.env.CIRCT_VERSION_BEFORE || 'unknown';
            const afterVer = process.env.CIRCT_VERSION_AFTER || 'unknown';

            const body = [
              `## Benchmark results for CIRCT PR [#${prNumber}](https://github.com/llvm/circt/pull/${prNumber})`,
              `> **${prTitle}**`,
              '',
              '| | Before | After |',
              '|---|---|---|',
              `| Commit | \`${baseSha}\` | \`${headSha}\` |`,
              `| Version | \`${beforeVer}\` | \`${afterVer}\` |`,
              '',
              reportBody,
              '',
              `[Full workflow run with artifacts](${runUrl})`,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.issue_number }}'),
              body,
            });
        env:
          CIRCT_VERSION_BEFORE: ${{ env.CIRCT_VERSION_BEFORE }}
          CIRCT_VERSION_AFTER: ${{ env.CIRCT_VERSION_AFTER }}

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ inputs.pr_number }}-benchmark
          retention-days: 90
          path: |
            tracker/pr-report.html
            tracker/pr-report.md
            tracker/pr-report.json
            tracker/before-summary.json
            tracker/after-summary.json

      - name: Upload test outputs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: pr-${{ inputs.pr_number }}-test-outputs
          path: |
            tracker/build_before/
            tracker/build_after/
