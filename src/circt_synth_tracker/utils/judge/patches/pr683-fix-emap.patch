# SPDX-License-Identifier: MIT
# Derived from mockturtle (https://github.com/lsils/mockturtle)
# Copyright (c) 2018-2019 mockturtle authors
# Source: https://github.com/lsils/mockturtle/pull/683
# Author: marcelwa
# Fixes an assert violation (float/double type mismatch, missing value reset)
# and a SIGSEGV (unguarded nullptr dereference) in the emap technology mapper.

diff --git a/include/mockturtle/algorithms/emap.hpp b/include/mockturtle/algorithms/emap.hpp
index 055d9b25b..e4b02605a 100644
--- a/include/mockturtle/algorithms/emap.hpp
+++ b/include/mockturtle/algorithms/emap.hpp
@@ -1107,7 +1107,7 @@ class emap_impl

     node_data.est_refs[0] = node_data.est_refs[1] = static_cast<double>( ntk.fanout_size( n ) );
     node_data.map_refs[0] = node_data.map_refs[1] = 0;
-    node_data.required[0] = node_data.required[1] = std::numeric_limits<float>::max();
+    node_data.required[0] = node_data.required[1] = std::numeric_limits<double>::max();

     if ( ntk.is_constant( n ) )
     {
@@ -1618,6 +1618,8 @@ class emap_impl

       /* reset mapping */
       node_match[index].map_refs[0] = node_match[index].map_refs[1] = 0u;
+      node_match[index].arrival[0] = node_match[index].arrival[1] = 0.0;
+      node_match[index].required[0] = node_match[index].required[1] = std::numeric_limits<double>::max();

       if ( ntk.is_constant( n ) )
         continue;
@@ -2343,6 +2345,13 @@ class emap_impl
         }
       }

+      // guard against unmapped nodes: if neither phase has a best gate, skip
+      if ( node_data.best_gate[0] == nullptr && node_data.best_gate[1] == nullptr )
+      {
+        // no valid mapping stored for this node (e.g., not in cover); skip arrival/area.
+        continue;
+      }
+
       uint8_t use_phase = node_data.best_gate[0] != nullptr ? 0 : 1;

       /* compute arrival of use_phase */
@@ -5969,4 +5978,4 @@ void emap_load_mapping( Ntk& ntk )
   } );
 }

-} /* namespace mockturtle */
\ No newline at end of file
+} /* namespace mockturtle */
